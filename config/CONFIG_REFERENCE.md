# RackBrain config reference

This document describes the `config/config.yaml` settings used by RackBrain. Paths are resolved
relative to the config base directory (the parent of `config/` when the config file lives in
`config/config.yaml`), unless they are absolute.

## Config discovery and path resolution

RackBrain discovers the config file in this order:

1) `--config /path/to/config.yaml`
2) `RACKBRAIN_CONFIG`
3) `RACKBRAIN_HOME/config/config.yaml`
4) `./config/config.yaml` (when running inside a checkout)
5) `XDG_CONFIG_HOME/rackbrain/config.yaml`
6) `~/.config/rackbrain/config.yaml`

After loading, RackBrain normalizes paths so they do not depend on the caller's CWD:

- `rules.files` are resolved to absolute paths.
- `logging.log_dir` is resolved relative to the base dir (or `RACKBRAIN_HOME` if set).
- `paths.state_dir` and `processing.timer_db_path` are resolved similarly.

Convenience env overrides:

- `RACKBRAIN_LOG_DIR`: overrides `logging.log_dir`
- `RACKBRAIN_STATE_DIR`: overrides `paths.state_dir`
- `RACKBRAIN_TIMER_DB_PATH`: overrides `processing.timer_db_path`

## Jira

### `jira.base_url`

Base URL for your Jira Server/Data Center instance (for example,
`https://jira.synnex.com`).

### `jira.pat` and `jira.pat_env`

RackBrain uses a personal access token (PAT) for Jira API access. Prefer the environment variable
named in `jira.pat_env` (default: `RACKBRAIN_JIRA_PAT`) and keep `jira.pat` empty in version
control.

## Rules

### `rules.files`

List of YAML rule files. RackBrain loads all rules from these files at startup and converts
relative paths into absolute ones using the config base directory.

## Polling

RackBrain fetches candidate tickets from Jira using JQL, then evaluates rules against each fetched
ticket.

Run polling via the CLI:

- `python3 -m rackbrain poll` (Linux/macOS)
- `py -m rackbrain poll` (Windows)

### `polling.jql`

`polling.jql` is the primary JQL used for normal rule processing.

Tip: use YAML block scalars (`|`) for multi-line JQL to avoid quoting and escaping issues.

### `polling.enabled`

Reserved flag for external wrappers. The built-in `rackbrain poll` command runs polling whenever
it is invoked, regardless of this setting.

### `polling.poll_interval_seconds`

Delay between poll cycles (default: `120` seconds).

### `polling.max_workers`

Thread pool size for per-ticket processing (default: `4`).

### `polling.max_results`

Maximum number of Jira issues fetched per query (default: `200`).

### `polling.project_key`, `polling.allowed_statuses`, `polling.lookback_hours`

Inputs used only when RackBrain generates a default JQL (when neither `--jql` nor `polling.jql`
are set).

### `polling.extra_queries`

Use `polling.extra_queries` to run additional JQL queries in the same poll cycle, but restrict each
query to a subset of rules.

This is useful when you need a wider or different "ticket fetch window" for a specific workflow
rule (for example, approval acknowledgements on older tickets) without changing which tickets are
evaluated by the rest of the ruleset.

Each entry supports:

- `name` (optional): label shown in poll output.
- `enabled` (optional, default `true`): set `false` to disable the query.
- `jql` (required): the JQL for this extra query.
- `only_rule_ids` (required): list of rule `id`s that are eligible to run for this query.
- `max_results` (optional): overrides `polling.max_results` for this query.

Notes:

- The primary query runs first (full ruleset).
- Extra queries run after, and RackBrain skips tickets already queued or processed earlier in the
  same cycle.

#### Example: approval ack for older tickets

This example runs only the `approval_request_ack` rule against tickets updated in the last hour,
without requiring a recent `created` time:

```yaml
polling:
  extra_queries:
    - name: approval_ack_old_tickets
      only_rule_ids: ["approval_request_ack"]
      max_results: 200
      jql: |
        project IN (MFGS)
        AND Location = Fremont
        AND updated >= -1h
        AND status = "In Progress"
        AND assignee = currentUser()
        ORDER BY updated DESC
```

## Processing

### `processing.required_combined_text_contains`

Optional safety gate: if set, RackBrain will **skip rule evaluation** unless the Jira ticket's
`summary + description` contains this literal substring (case-insensitive).

This is useful to ensure RackBrain only processes tickets with a known bot or template marker like:

```yaml
processing:
  required_combined_text_contains: "This ticket generated by EVE BOT"
```

### `processing.assign_to`, `processing.reassign_to`, `processing.transition_to`

Default Jira actions applied for a matching rule. These can be overridden per rule in the rule
file.

### `processing.allowed_statuses`

List of Jira status names that are eligible for processing. Tickets outside this list are skipped.

### `processing.timer_db_path`

Override the SQLite path used for timer state. If unset, RackBrain uses
`RACKBRAIN_TIMER_DB_PATH` or the default `state/rackbrain_state.sqlite`.

## Paths

### `paths.state_dir`

Base directory for runtime state. Used for the timer database and polling state. You can override
this via `RACKBRAIN_STATE_DIR`.

## Logging

### `logging.enabled`, `logging.log_dir`, `logging.log_file`

Enable processing logs and choose where the JSON or text logs are written. When
`logging.rotate_daily` is enabled, the log file name gets a `_YYYY-MM-DD` suffix.

`logging.log_dir` can be overridden via `RACKBRAIN_LOG_DIR`.

### `logging.log_format`

Use `json` for structured logs (required for `rackbrain metrics` and the polling "edited today"
summary).

### `logging.rule_match_history`

Optional section to configure the per-rule match history file:

```yaml
logging:
  rule_match_history:
    enabled: true
    file: "rackbrain_rule_matches.txt"
    include_dry_runs: false
```

## Integration environment variables (non-config)

RackBrain keeps secrets out of YAML. Most integrations are enabled/disabled by environment
variables rather than config keys.

### Jira authentication

- `jira.pat_env` names the environment variable that holds the Jira PAT (default:
  `RACKBRAIN_JIRA_PAT`).

### hyvetest DB enrichment

DB enrichment uses `rackbrain/adapters/hyvetest_client.py` (via `database_config.py`):

- `RACKBRAIN_DB_HOST`, `RACKBRAIN_DB_USER`, `RACKBRAIN_DB_PASS`, `RACKBRAIN_DB_NAME`

If any are missing, DB lookups are skipped (rules that depend on DB-only fields may not match).

### TestView

TestView integration uses `Testviewlog.py`:

- `HYVE_TESTVIEW_COOKIE` (required for TestView API calls)
- `HYVE_TESTVIEW_BASE_URL` (optional override of the TestView base URL)

### EVE / ILOM command execution

Command steps run via `rackbrain/eve_command_runner.py` and prefer the SR1 â†’ RAMSES remote wrapper
(`rackbrain/eve_remote.py` + `bin/eve_cmd_runner_remote.sh`).

Common environment variables used by the runner path:

- `RAMSES_TESTER_PASS`: required by `bin/eve_cmd_runner_remote.sh` for the RAMSES SSH hop.
- `EVE_CMD_RUNNER_REMOTE_PATH`: optional override for the remote wrapper script location.
- `EVE_CMD_RUNNER_PATH`: optional override for which `eve_cmd_runner.sh` is streamed to RAMSES.

### Cinder verification (special-case tickets)

The Cinder verification report builder uses both a MySQL query (via the `mysql` CLI) and an HTTP
call to Seizo:

- `RACKBRAIN_CINDER_DB_PASS` (required; secret)
- Optional overrides: `RACKBRAIN_SEIZO_BASE`, `RACKBRAIN_SEIZO_TIMEOUT_SECONDS`,
  `RACKBRAIN_CINDER_REPORT_MAX_CHARS`, `RACKBRAIN_CINDER_DB_HOST`, `RACKBRAIN_CINDER_DB_USER`,
  `RACKBRAIN_CINDER_DB_NAME`, `RACKBRAIN_CINDER_DB_PASS_ENV`
