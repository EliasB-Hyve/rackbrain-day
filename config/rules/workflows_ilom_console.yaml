# Workflow rules: ILOM console connection failure
# Multi-step flow: check ILOM connectivity -> request ROT cabling reseat -> follow up after reseat.
# Rule YAML reference (for rule authors): config/rules/RULES_YAML_REFERENCE.md

- id: ilom_console_failed_show_host_initial
  name: "Failed to connect ILOM console – show /SP/network + eve_ip (initial)"
  description: >
    For EVE Fremont tickets where SLT reports 'Failed to connect ILOM console.'.
    First run the eve_ip helper to capture IP mapping (even if it returns a non-zero
    status). Then run '{ilom} show /SP/network' to verify ILOM responsiveness. If the
    check fails, instruct Test to reseat ROT cabling and reassign back. If it passes,
    include outputs in the comment.
  priority: 20
  scope:
    arch: "EVE"
    jira_location:
      contains: "Fremont"
    jira_customer:
      contains: "EVE"
    db_latest_failed_testset:
      not_contains: "PRETEST"
    jira_comments_text:
      not_contains: "reseat the ROT cabling"
    # failure_message:
    #   not_contains: "Failed to connect sunservice."
  patterns:
    - type: contains
      value: "*Failure Message:* Failed to connect ILOM console."
  action:
    type: "comment_only"
    close: false
    comment_template: ""
    command_steps:
      - id: "eve_ip"
        cmd: "{local} python3 /home/tester/WesleyH/eve_ip.pyc {sn}"
        stop_on_decision: false
      - id: "ilom_show_host"
        cmd: "{ilom} show /SP/network"
        expect_status: 0
        stop_on_decision: true
        on_expect_fail_comment: |
          Test, please reseat the ROT cabling. I am unable to connect to ILOM.
          
          {command_eve_ip_stdout_code}

          Please reassign ticket back to me once reseated.
          {command_ilom_show_host_stdout_code}
        on_expect_pass_comment: |
          Test, I am able to connect to ILOM when manually checking, please release from repair and retest.
          
          {command_eve_ip_stdout_code}

          sample ILOM output:
          {command_ilom_show_host_stdout_code}


#- id: ilom_console_failed_show_host_after_reseat
#  name: "Failed to connect ILOM console – show /SP/network + eve_ip (after ROT cabling reseat)"
#  description: >
#    Follow-up for the ILOM console connection failure after ROT cabling reseat:
#    run eve_ip and '{ilom} show /SP/network'. If still failing, send to repair;
#    if passing, ask to release from repair and retest.
#  priority: 20
#  scope:
#    arch: "EVE"
#    jira_location:
#      contains: "Fremont"
#    jira_customer:
#      contains: "EVE"
#    db_latest_failed_testset:
#      not_contains: "PRETEST"
#    jira_comments_text:
#      contains: "reseat the ROT cabling"
#    # failure_message:
#    #   not_contains: "Failed to connect sunservice."
#  patterns:
#    - type: contains
#      value: "*Failure Message:* Failed to connect ILOM console."
#  action:
#    type: "comment_only"
#    close: false
#    command_steps:
#      - id: "eve_ip"
#        cmd: "{local} python3 /home/tester/WesleyH/eve_ip.pyc {sn}"
#        stop_on_decision: false
#      - id: "ilom_show_host"
#        cmd: "{ilom} show /SP/network"
#        expect_status: 0
#        stop_on_decision: true
#        on_expect_fail_comment: |
#          Test, please send server to repair
#          
#          {command_eve_ip_stdout_code}
#
#          I am still not able to connect to ILOM.
#        on_expect_pass_comment: |
#           Please release from repair and retest. After the ROT cabling reseat, I am now able to connect to ILOM
#         
#           {command_eve_ip_stdout_code}
#
#           sample ILOM output:
#           {command_ilom_show_host_stdout_code}
#           

#############################################################################################
- id: ilom_unreachable_pretest_initial
  name: "PRETEST: Failed to connect ILOM console – show /SP/network + eve_ip (initial)"
  description: >
    For EVE Fremont tickets failing in PRETEST with 'Failed to connect ILOM console.'.
    Run eve_ip then attempt '{ilom} show /SP/network'. If still failing, instruct Test
    to check mgmt path / reseat ROT cabling and reassign back.

  priority: 20

  scope:
    arch: "EVE"
    jira_location:
      contains: "Fremont"
    jira_customer:
      contains: "EVE"
    db_latest_failed_testset:
      contains: "PRETEST"
    jira_comments_text:
      not_contains: "(Marker) ILOM unreachable in PRETEST"

  patterns:
    - type: contains
      value: "Failed to connect ILOM console."

  action:
    type: "comment_only"
    close: false
    command_steps:
      - id: "eve_ip"
        cmd: "{local} python3 /home/tester/WesleyH/eve_ip.pyc {sn}"
        stop_on_decision: false
      - id: "ilom_show_host"
        cmd: "{ilom} show /SP/network"
        expect_status: 0
        stop_on_decision: true
        on_expect_fail_comment: |
          Test, 
          ILOM unreachable in PRETEST. Please check 1G cable and use eve_ip to verify.
          IF ILOM is back online please rerun PRETEST
          IF ILOM still down, please move to other location.
          IF ILOM still down then reassign back for desposition

          {command_eve_ip_stdout_code}

          Attempted ILOM check:
          {command_ilom_show_host_stdout_code}
        on_expect_pass_comment: |
          Test, PRETEST reported ILOM unreachable, but I can connect now.
          Please retest.

          (Marker) ILOM unreachable in PRETEST

          {command_eve_ip_stdout_code}

          sample ILOM output:
          {command_ilom_show_host_stdout_code}



