- id: ilom_pci_link_error_affects
  name: "PCI link error â€“ capture fmadm Affects line"
#Rule YAML reference (for rule authors): config/rules/RULES_YAML_REFERENCE.md
  description: >
    For EVE servers where ILOM reports a PCI link error on a PCI card.
    Run faultmgmt "fmadm faulty -a" and surface the Affects line for the
    suspect FRU so repair can identify the impacted module.
  priority: 20
  allow_high_slt_attempts: true
  scope:
    arch: "EVE"
    jira_location:
      contains: "Fremont"
    jira_customer:
      contains: "EVE"
    db_latest_failed_testset:
      not_contains: "PRETEST"
  patterns:
    - type: contains
      value: "A PCI link error has been detected on a PCI card."
  action:
    type: "comment_only"
    close: false
    ilom_filter_contains:
      - "A PCI link error has been detected on a PCI card."
    comment_template: |

      Test, please send this server to repair.
      
      Repair,

      There is a PCI link error on a PCI card. Please reseat the module and its associated connections.

      fmadm faulty -a details (Affects line):
      {command_fmadm_faulty_pci_selected_lines_code}

      ILOM Open Problems:
      {ilom_open_problems_code}
    command_steps:
      - id: "fmadm_faulty_pci"
        cmd: "{faultmgmt} fmadm faulty -a"
        expect_status: 0
        expect_contains: "Suspect 1 of 1"
        line_contains: "Affects"
        line_before: 0
        line_after: 0
        stop_on_decision: false


- id: bifurcated_block_extract
  name: "Bifurcation detected â€“ extract PCIE info block"
  description: >
    If the ticket contains 'is_bifurcated: bifurcated', extract that line and
    the five lines before it from the failure message and include them in a
    Jira comment.
  priority: 15
  scope:
    arch: "EVE"
    jira_location:
      contains: "Fremont"
    jira_customer:
      contains: "EVE"
    db_latest_failed_testset:
      not_contains: "PRETEST"
  patterns:
    - type: contains
      value: "is_bifurcated: bifurcated"
  action:
    type: "comment_only"
    close: false
    failure_message_line_contains: "is_bifurcated: bifurcated"
    failure_message_line_before: 4
    failure_message_line_after: 0
    comment_template: |
      Test, please send to repair. 
      

      Repair,
      Please reseat PCI connections for the bifurcated component(s).

      Check if issue is solved by running command in hostnic:
      
      
        lspci -vvv -s [PCI_address]   | grep -i LnkSta


      {failure_message_selected_code}


- id: iou_bay_pcie_data_connector_missing_plain_english
  name: "IOU bay PCIe data connector missing in system (plain English)"
  description: >
    When hwdiag_io_config reports an IOU Bay in system as MISSING, extract the IOU bay and
    expected (GI) slot and state the issue in plain English.
  priority: 25
  scope:
    arch: "EVE"
    jira_location:
      contains: "Fremont"
    jira_customer:
      contains: "EVE"
    failure_message:
      contains: "MISSING"
    # Confirmation: require the same hwdiag block to be present in the ticket body too.
    combined_text:
      contains: "hwdiag_io_config -> IOU Bay"
  patterns:
    - type: contains
      value: "MISSING"
  action:
    type: comment_only

    text_extracts:
      - name: iou_bay
        source: failure_message
        line_contains: "hwdiag_io_config -> IOU Bay"
        line_between_start_contains: "IOU Bay "
        line_between_end_contains: " in GI"
        take: first
        default: "?"

      - name: gi_slot
        source: failure_message
        line_contains: "PCIe Data Connectors on IOU Module: ['"
        line_between_start_contains: "['"
        line_between_end_contains: "'"
        take: first
        default: "?"

    comment_template: |

      Test, please send to repair.

      Repair,

      IOU{iou_bay} PCIe connection is missing in the system. Expected PCIe cable in slot {gi_slot} (correct location).

      Please connect/seat the PCIe cable to slot {gi_slot} on IOU{iou_bay}.


- id: iou_bay_pcie_data_cable_not_connected_plain_english
  name: "IOU bay PCIe cable not connected in system (plain English)"
  description: >
    When hwdiag_io_cables shows a PCIe Data Cable expected in GI but "Not Connected" in system,
    call out the IOU bay and missing cable connection number(s) in plain English.
  priority: 30
  scope:
    arch: "EVE"
    jira_location:
      contains: "Fremont"
    jira_customer:
      contains: "EVE"
    # Confirmation: require the same hwdiag block to be present in the ticket body too.
    combined_text:
      contains: "hwdiag_io_config -> IOU Bay"
    failure_message:
      contains: "IOU Module: Not Connected"
  patterns:
    - type: contains
      value: "hwdiag_io_cables -> Cable#"
    - type: contains
      value: "IOU Bay: -, IOU Module: Not Connected"
  action:
    type: comment_only

    text_extracts:
      - name: iou_bay
        source: failure_message
        line_contains: "hwdiag_io_config -> IOU Bay"
        line_between_start_contains: "IOU Bay "
        line_between_end_contains: " in GI"
        take: first
        default: "?"

      - name: missing_connections
        source: failure_message
        line_contains: "IOU Bay: -, IOU Module: Not Connected"
        line_between_start_contains: "PCIe Data Cable#"
        line_between_end_contains: ": IOU Bay"
        take: all
        default: "?"

    comment_template: |

      Test, please send to repair.

      Repair,

      IOU{iou_bay} is missing PCIe cable connection(s): {missing_connections}

      Please reseat the PCIe cable(s) for the missing connection(s) on IOU{iou_bay}.


- id: iou_bay_pcie_data_connector_mismatch_plain_english
  name: "IOU bay PCIe data connector mismatch (plain English)"
  description: >
    When hwdiag_io_config shows IOU Bay connector mismatch between "in GI"
    (correct/expected) and "in system" (actual/wrong), extract the bay and
    connector numbers and state the mismatch in plain English.
  priority: 20
  scope:
    arch: "EVE"
    jira_location:
      contains: "Fremont"
    jira_customer:
      contains: "EVE"
    db_latest_failed_testset:
      not_contains: "PRETEST"
    # Confirmation: require the same hwdiag block to be present in the ticket body too.
    combined_text:
      contains: "hwdiag_io_config -> IOU Bay"
    failure_message:
      contains: "hwdiag_io_config -> IOU Bay"
  patterns:
    - type: contains
      value: "hwdiag_io_config -> IOU Bay"
    - type: not_contains
      value: "Not Connected"
  action:
    type: comment_only

    # Extract values using marker-based rules (no regex required).
    text_extracts:
      - name: iou_bay
        source: failure_message
        line_contains: "hwdiag_io_config -> IOU Bay"
        line_between_start_contains: "IOU Bay "
        line_between_end_contains: " in GI"
        take: first
        default: "?"

      - name: gi_slot
        source: failure_message
        # Pick the first connector list line (GI comes before system in hwdiag_io_config)
        line_contains: "PCIe Data Connectors on IOU Module: ['"
        line_between_start_contains: "['"
        line_between_end_contains: "'"
        take: first
        default: "?"

      - name: system_slot
        source: failure_message
        # Pick the last connector list line (system comes after GI in hwdiag_io_config)
        line_contains: "PCIe Data Connectors on IOU Module: ['"
        line_between_start_contains: "['"
        line_between_end_contains: "'"
        take: last
        default: "?"

    comment_template: |

      Test, please send to repair.
      
      Repair,


      IOU{iou_bay} has PCIe cable plugged into slot {system_slot} instead of slot {gi_slot} (correct location).


      Please verify this and move the PCIe cable to slot {gi_slot} for IOU{iou_bay}.
      
      
- id: iou_required_pcie_cable_missing_plain_english
  name: "IOU required PCIe cable missing (plain English)"
  description: >
    When ILOM Open_Problems indicates a required PCIe cable is missing (SPENV-8000-VK),
    extract the IOU number from Resource:/SYS/IOU# and describe the issue in plain English.
  priority: 20
  allow_on_same_failure: true

  scope:
    arch: "EVE"
    jira_location:
      contains: "Fremont"
    jira_customer:
      contains: "EVE"

    # Trigger by ILOM Open_Problems fault
    ilom_open_problems_raw:
      contains: "SPENV-8000-VK"

  patterns:
    - type: contains
      value: "SPENV-8000-VK"
    - type: contains
      value: "A required PCIe cable between the motherboard and I/O Unit"

  action:
    type: comment_only
    close: false

    text_extracts:
      - name: iou_resource
        source: ilom_open_problems_raw
        line_contains: "Resource:/SYS/IOU"
        line_between_start_contains: "Resource:"
        line_between_end_contains: ","
        take: first
        default: "/SYS/IOU?"

      - name: iou_num
        source: ilom_open_problems_raw
        line_contains: "Resource:/SYS/IOU"
        line_between_start_contains: "/SYS/IOU"
        line_between_end_contains: ","
        take: first
        default: "?"

    comment_template: |

      Test, please send to repair.

      Repair,

      Power on is blocked because a required PCIe cable is missing for IOU{iou_num} ({iou_resource}).
      Please check/insert/reseat the required PCIe cable between the motherboard and IOU{iou_num}.
      After fixing cabling, retry power on and re-run the test.
      



- id: ilom_pci_data_link_layer_inactive_affects
  name: "PCIe link layer inactive -> capture fmadm Affects line"
  description: >
    For EVE servers where ILOM reports a PCIe link-layer-inactive fault
    (fault.io.pcie.data-link-layer-inactive). Run faultmgmt "fmadm faulty -a"
    and surface the Affects line so repair can identify the impacted FRU/module.
  priority: 20
  allow_high_slt_attempts: true
  scope:
    arch: "EVE"
    jira_location:
      contains: "Fremont"
    jira_customer:
      contains: "EVE"
    db_latest_failed_testset:
      not_contains: "PRETEST"
    jira_comments_text:
      not_contains: "PCIe link-layer-inactive (fault.io.pcie.data-link-layer-inactive)"
  patterns:
    - type: contains
      value: "fault.io.pcie.data-link-layer-inactive"
  action:
    type: "comment_only"
    close: false
    ilom_filter_contains:
      - "fault.io.pcie.data-link-layer-inactive"
      - "PCIe link layer is inactive"
    comment_template: |

      Test, please send this server to repair.

      Repair,

      ILOM reports a PCIe link-layer-inactive fault:
      `fault.io.pcie.data-link-layer-inactive`

      Please reseat the affected module and its associated connections.

      fmadm faulty -a details (Affects line):
      {command_fmadm_faulty_pci_link_layer_inactive_selected_lines_code}

      ILOM Open Problems:
      {ilom_open_problems_code}
    command_steps:
      - id: "fmadm_faulty_pci_link_layer_inactive"
        cmd: "{faultmgmt} fmadm faulty -a"
        expect_status: 0
        expect_contains: "Suspect"
        line_contains: "Affects"
        line_before: 0
        line_after: 0
        stop_on_decision: false




# Untested rules
# Move rules out of this file once validated.
# Rule YAML reference (for rule authors): config/rules/RULES_YAML_REFERENCE.md

- id: pcie_lnksta_check_pretest_start_pretest_else_slt
  name: "PCIe link speed/width mismatch -> hostnic LnkSta (PRETEST)"
  description: >
    For PRETEST: run hostnic LnkSta for each PCIe address listed in the ticket (GI lines).
    If any output contains 'downgraded' OR any address has no output, send to repair and start SLT for logs.
    Otherwise start PRETEST and comment.
  priority: 30
  scope:
    arch: "EVE"
    jira_location:
      contains: "Fremont"
    jira_customer:
      contains: "EVE"
    db_latest_failed_testset:
      contains: "PRETEST"
  patterns:
    - type: contains
      value: "Link speed/width for PCIE slot"
    - type: contains
      value: "Check Result: FAIL"
    - type: contains
      value: "CHECK_PCIE_LINK_SPEED_WIDTH"
    - type: not_contains
      value: "The number of Drive on the UUT is inconsistent with the number on SFCS"
    - type: not_contains
      value: "The number of drives read on the server is inconsistent with that in ilom, seems some Drive is not ready."
  action:
    type: comment_only

    text_extracts:
      - name: pcie_addresses
        source: combined_text
        line_contains: ":00.0 in GI:"
        line_between_start_contains: "slot "
        line_between_end_contains: " in GI:"
        take: all
        default: ""

    command_steps:
      - id: pcie_lnksta
        for_each_extract: pcie_addresses
        cmd: "{hostnic} echo '--- [item] ---' ; lspci -vvv -s [item] | grep -i LnkSta"
        expect_status: 0
        expect_contains: "LnkSta"
        expect_not_contains: "downgraded"
        stop_on_decision: true

        start_testview_on_pass: true
        testview_operation_on_pass: "PRETEST"
        testview_use_validate_on_pass: true

        start_testview_on_fail: true
        testview_operation_on_fail: "SLT"
        testview_use_validate_on_fail: true

        on_expect_fail_comment: |
          Test, please send to repair.

          Repair,
          Host NIC PCIe link is downgraded OR LnkSta output is missing for one/more devices.

          Started SLT to generate logs for repair.

          Addresses checked (00.0 only):
          {pcie_addresses}

          Commands + output:
          {all_commands_code}

    comment_template: |
      PCIe LnkSta check looks OK on hostnic (no downgraded links and LnkSta output present for all addresses listed).

      Test,
      Started PRETEST.

      Addresses checked (00.0 only):
      {pcie_addresses}

      Commands + output:
      {all_commands_code}
      
- id: eve_pci_link_error_ssd_reseat
  name: "PCI link error on SSD -> capture fmadm Affects and send to repair"
  description: >
    For EVE servers where ILOM reports a PCI link error on an SSD FRU (e.g. /SYS/IOU8/SSD801).
    Run faultmgmt "fmadm faulty -a" and surface the Affects line so repair can identify which SSD/IOU is impacted.
    Ask repair to reseat the SSD module / backplane / IOU PCIe connections.

  priority: 24
  allow_high_slt_attempts: true

  scope:
    arch: "EVE"
    jira_location:
      contains: "Fremont"
    jira_customer:
      contains: "EVE"
    # usually not PRETEST-specific; keep it generic
    # if you want only NOT PRETEST, uncomment:
    # db_latest_failed_testset:
    #   not_contains: "PRETEST"

    # Make sure ILOM text exists (either in fetched ILOM or pasted into ticket)
    combined_text:
      contains: "A PCI link error has been detected on a PCI card."

  patterns:
    - type: contains
      value: "A PCI link error has been detected on a PCI card."
    # ensure it's SSD-related (match ILOM Open Problems line like "SSD801 (IOU 8 SSD 801)")
    - type: regex
      value: "(?i)\\bSSD\\s*\\d+\\b|/SYS/IOU\\d+/SSD\\d+"

  action:
    type: "comment_only"
    close: false

    ilom_filter_contains:
      - "A PCI link error has been detected on a PCI card."

    comment_template: |

      Test, please send this server to repair.

      Repair,

      ILOM reports a PCI link error on an SSD (reduced link speed).
      Please reseat the affected SSD module and its associated PCIe/backplane/IOU connections.
      If issue persists, swap SSD with a known-good one to verify if fault follows the SSD.

      fmadm faulty -a details (Affects line):
      {command_fmadm_faulty_ssd_pcie_selected_lines_code}

      ILOM Open Problems:
      {ilom_open_problems_code}

    command_steps:
      - id: "fmadm_faulty_ssd_pcie"
        cmd: "{faultmgmt} fmadm faulty -a"
        expect_status: 0
        expect_contains: "Suspect"
        # limit to the SSD affects line
        line_contains: "Affects"
        line_before: 0
        line_after: 0
        # optional: only keep lines that mention SSD/IOU in that affects line
        # (if your command_steps supports an additional filter; if not, ignore)
        stop_on_decision: false



#==========================================================================================================================================================
- id: eve_hwdiag_on_vr_check_all_nonzero_route_fallback
  name: "EVE HWDIAG_ON: vr_check all non-zero (fallback matcher)"
  priority: 80
  allow_on_same_failure: true
  scope:
    poll_context:
    contains: "approval_ack_old_tickets"
    arch: "EVE"
    jira_location:
      contains: "Fremont"
    jira_customer:
      contains: "EVE"
    failure_message:
      contains: "hwdiag cpld vr_check all"
    
  patterns:
    - type: contains
      value: "2_HWDIAG_ON"
    - type: contains
      value: "hwdiag cpld vr_check all"
  action:
    type: "comment_only"
    close: false
  
    comment_template: |
  
      Test, please send to repair
      
      Repair,
      HWDIAG_ON failed on `hwdiag cpld vr_check all` (non-zero).
      Key output:
      {command_vr_check_selected_lines_code}
  
    command_steps:
      - id: "vr_check"
        cmd: "{diag} hwdiag cpld vr_check all"
        expect_status: 0
        stop_on_decision: false
  
        line_contains: "Voltage Regulator Check Result"
        line_before: 120
        line_after: 20
        line_only: false

#======================================================================================================================================================

- id: eve_hwdiag_on_i2c_test_all_v_nonzero_route_repair
  name: "EVE HWDIAG_ON: i2c test all -v non-zero (capture failing rows)"
  priority: 80
  allow_on_same_failure: true

  scope:
    poll_context:
      contains: "approval_ack_old_tickets"
    arch: "EVE"
    jira_location:
      contains: "Fremont"
    jira_customer:
      contains: "EVE"
    failure_message:
      contains: "hwdiag i2c test all -v"

  patterns:
    - type: contains
      value: "HWDIAG_ON"
    - type: contains
      value: "hwdiag i2c test all -v"

  action:
    type: "comment_only"
    close: false

    comment_template: |
      Test, please send to repair

      Repair,
      HWDIAG_ON failed on `hwdiag i2c test all -v`.

      Failed rows:
      {command_i2c_fail_access_selected_lines_code}
      {command_i2c_fail_timeout_selected_lines_code}
      {command_i2c_fail_error_selected_lines_code}

      Summary:
      I2C Test Result: FAILED

    command_steps:
      - id: "i2c_fail_access"
        cmd: "{diag} hwdiag i2c test all -v || true"
        expect_status: 0
        stop_on_decision: false
        line_contains: "Access failed"
        line_before: 0
        line_after: 0
        line_only: true

      - id: "i2c_fail_timeout"
        cmd: "{diag} hwdiag i2c test all -v || true"
        expect_status: 0
        stop_on_decision: false
        line_contains: "Timeout"
        line_before: 0
        line_after: 0
        line_only: true

      - id: "i2c_fail_error"
        cmd: "{diag} hwdiag i2c test all -v || true"
        expect_status: 0
        stop_on_decision: false
        line_contains: "ERROR"
        line_before: 0
        line_after: 0
        line_only: true

#======================================================================================================================================================
- id: eve_rot_cable_hostnic_check_send_repair
  name: "EVE ROT cable / HostNIC assert – send to repair"
  description: >
    For EVE tickets failing 6_CHECK_ROT_CABLE with HostNIC VID:DID check result FAIL.
    Send to repair to debug ROT WIPE cable and HostNIC cabling / connection.
  priority: 20

  scope:
    arch: "EVE"
    jira_location:
      contains: "Fremont"
    jira_customer:
      contains: "EVE"
    db_latest_failed_testset:
      not_contains: "PRETEST"

    # Adjust this key name to your actual field if needed:
    db_latest_failed_testcase:
      contains: "CHECK_ROT_CABLE"

    failure_message:
      contains: "VID:DID:SSVID:SSDID"
    combined_text:
      contains: "HOSTNIC"

  patterns:
    - type: contains
      value: "CHECK_ROT_CABLE"
    - type: contains
      value: "VID:DID:SSVID:SSDID"
    - type: contains
      value: "HOSTNIC"
    - type: contains
      value: "Check Result: FAIL"

  action:
    type: "comment_only"
    close: false

    comment_template: |

      Test, please send this server to repair.

      Repair,

      Server {sn} failed testcase 6_CHECK_ROT_CABLE.
      Failure indicates HostNIC VID/DID SSVID/SSDID check failed after assert.

      Please debug ROT WIPE cable and HostNIC:
      - Reseat ROT WIPE cable (both ends) and verify connection
      - Reseat HostNIC / related PCIe data cables and verify connector mapping
      - Re-run 6_CHECK_ROT_CABLE after reseat

      Please refer to ticket failure message and SSH logs for details.

      ILOM Open Problems:
      {ilom_open_problems_code}


    # No extra command needed for this case (Open Problems already empty in sample)
    command_steps: []

#==========================================================================================================================================================
- id: eve_rot_smartnic_boot_fwid_not_found
  name: "EVE ROT SMARTNIC boot fwid missing – send to repair"
  description: >
    For EVE servers where failure message shows
    'Boot fwid 2' not found in readSerial output.
    Send to repair for ROT to SMARTNIC debugging.
  priority: 20

  scope:
    arch: "EVE"
    jira_location:
      contains: "Fremont"
    jira_customer:
      contains: "EVE"
    db_latest_failed_testset:
      not_contains: "PRETEST"

    failure_message:
      contains: "Boot fwid 2"

  patterns:
    - type: contains
      value: "'Boot fwid 2' not found in readSerial output"
    - type: contains
      value: "readSerial"

  action:
    type: "comment_only"
    close: false

    comment_template: |

      Test, please send this server to repair.

      Repair,

      Server {sn} failed ROT firmware verification.
      Failure indicates missing SMARTNIC Boot FWID in readSerial output.

      Please help to debug ROT to SMARTNIC:
      - Reseat: WIPE → ROT → CON → IOU Power → SMARTNIC
      - Replace (good parts): WIPE → ROT → CON → IOU Power → SMARTNIC → Riser → ROT/FIM


      Please refer to ticket failure message and logs for details.

      ILOM Open Problems:
      {ilom_open_problems_code}

    command_steps: []
    
#==========================================================================================================================================================    
- id: fault_cpu_intel_ultrapath_link_width_degraded_general
  name: "fault.cpu.intel.ultrapath.link_width_degraded – ILOM general"
  description: >
    For EVE Fremont servers where ILOM / fmadm faulty -a reports
    fault.cpu.intel.ultrapath.link_width_degraded (UPI link width degraded),
    regardless of test flow. Used for all ILOM-related failures.
  priority: 18
  scope:
    arch: "EVE"
    jira_location:
      contains: "Fremont"
    jira_customer:
      contains: "EVE"

    # Primary trigger: ILOM / fmadm content
    ilom_open_problems_raw:
      contains: "Ultrapath"
  patterns:
    - type: contains
      value: "fault.cpu.intel.ultrapath.link_width_degraded"
    - type: contains
      value: "Ultrapath Interconnect"
    - type: contains
      value: "UPI"
    - type: contains
      value: "degraded width"
  action:
    type: "comment_only"
    close: false

    ilom_filter_contains:
      - "Ultrapath"
      - "UPI"
      - "degraded"
      - "Resource:/SYS/MB"
      - "Resource:/SYS/MB/P0"
      - "Resource:/SYS/MB/P1"

    comment_template: |

      Test, please send this server to repair
      
      Repair,

      Server {sn} shows UPI interconnect link width degradation
      (fault.cpu.intel.ultrapath.link_width_degraded).

      This indicates reduced CPU-to-CPU interconnect lanes.

      Please perform standard UPI rework:
      1) please reseat CPU0 and CPU1.
      2) Inspect sockets for bent pins / contamination.
      3) Reinstall heatsinks with even pressure.
      4) Swap CPUs with known-good units if needed.
      5) If fault remains on /SYS/MB, consider MB replace.

      fmadm faulty -a details:
      {command_fmadm_faulty_selected_lines_code}

      ILOM Open Problems :
      {ilom_open_problems_code}

    command_steps:
      - id: "fmadm_faulty"
        cmd: "{faultmgmt} fmadm faulty -a"
        expect_status: 0
        stop_on_decision: false
        line_contains: "Affects"
        line_only: true


################################################################
- id: fault_cpu_amd_xgmi_link_ce_general
  name: "fault.cpu.amd.xgmi.link_ce – ILOM general"
  description: >
    For EVE Fremont servers where ILOM Open_Problems reports AMD xGMI link corrected errors
    (fault.cpu.amd.xgmi.link_ce or fault.ops.cpu.amd.xgmi.link_ce), regardless of testcase.
    In that case, run "fmadm faulty -a" and show the lines containing "Affects".
  priority: 18
  scope:
    arch: "EVE"
    jira_location:
      contains: "Fremont"
    jira_customer:
      contains: "EVE"
    ilom_open_problems_raw:
      contains: "xgmi"
  patterns:
    - type: contains
      value: "fault.cpu.amd.xgmi.link_ce"
    - type: contains
      value: "fault.ops.cpu.amd.xgmi.link_ce"
    - type: contains
      value: "xgmi"
  action:
    type: "comment_only"
    close: false

    ilom_filter_contains:
      - "fault.cpu.amd.xgmi.link_ce"
      - "fault.ops.cpu.amd.xgmi.link_ce"
      - "Resource:/SYS/MB"
      - "Resource:/SYS/MB/P0"
      - "Resource:/SYS/MB/P1"

    comment_template: |

      Test, please send this server to repair
      
      Repair,

      Server {sn} shows AMD xGMI link corrected error(s):
      - fault.cpu.amd.xgmi.link_ce / fault.ops.cpu.amd.xgmi.link_ce

      Please perform standard xGMI/CPU interconnect rework:
      1) Power off and reseat CPU0/CPU1.
      2) Inspect sockets for bent pins / contamination.
      3) Reinstall heatsinks with even pressure.
      4) If issue persists, swap CPU(s) with known-good to isolate CPU vs motherboard.
      5) If fault remains affecting /SYS/MB, replace motherboard/tray per repair SOP.

      fmadm faulty -a (Affects lines):
      {command_fmadm_faulty_selected_lines_code}

      ILOM Open Problems:
      {ilom_open_problems_code}

    command_steps:
      - id: "fmadm_faulty"
        cmd: "{faultmgmt} fmadm faulty -a"
        expect_status: 0
        stop_on_decision: false
        line_contains: "Affects"
        line_only: true

###################################################################################################

- id: fault_chassis_power_fail_general
  name: "fault.chassis.power.fail – ILOM general"
  description: >
    For EVE Fremont servers where ILOM Open_Problems reports
    fault.chassis.power.fail / SPENV-8000-LT (power source failed or unavailable),
    regardless of test flow. Show primary affected resource and Affects lines.
  priority: 20
  allow_on_same_failure: true

  scope:
    arch: "EVE"
    jira_location:
      contains: "Fremont"
    jira_customer:
      contains: "EVE"

    # Primary trigger: ILOM / Open Problems content
    ilom_open_problems_raw:
      contains: "SPENV-8000-LT"

  patterns:
    - type: contains
      value: "fault.chassis.power.fail"
    - type: contains
      value: "A power source has failed or is not available"

  action:
    type: "comment_only"
    close: false

    ilom_filter_contains:
      - "fault.chassis.power.fail"
      - "A power source has failed or is not available"

    text_extracts:
      - name: first_resource
        source: ilom_open_problems_raw
        line_contains: "Resource:"
        line_between_start_contains: "Resource:"
        line_between_end_contains: ","
        take: first
        default: "/SYS/?"

    comment_template: |

      Test, please send this server to repair

      Repair,

      Server {sn} shows chassis power fault:
      - fault.chassis.power.fail (SPENV-8000-LT)
      - A power source has failed or is not available to the server.

      Primary affected resource: {first_resource}


      ILOM Open Problems:
      {ilom_open_problems_code}

      Please check power delivery/cabling for the affected resource first
      (IOU/PCIe power path, motherboard power path, and PSU/backplane as applicable).

