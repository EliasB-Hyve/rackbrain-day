- id: ilom_pci_link_error_affects
  name: "PCI link error â€“ capture fmadm Affects line"
#Rule YAML reference (for rule authors): config/rules/RULES_YAML_REFERENCE.md
  description: >
    For EVE servers where ILOM reports a PCI link error on a PCI card.
    Run faultmgmt "fmadm faulty -a" and surface the Affects line for the
    suspect FRU so repair can identify the impacted module.
  priority: 20
  allow_high_slt_attempts: true
  scope:
    arch: "EVE"
    jira_location:
      contains: "Fremont"
    jira_customer:
      contains: "EVE"
    db_latest_failed_testset:
      not_contains: "PRETEST"
  patterns:
    - type: contains
      value: "A PCI link error has been detected on a PCI card."
  action:
    type: "comment_only"
    close: false
    ilom_filter_contains:
      - "A PCI link error has been detected on a PCI card."
    comment_template: |

      Test, please send this server to repair.
      
      Repair,

      There is a PCI link error on a PCI card. Please reseat the module and its associated connections.

      fmadm faulty -a details (Affects line):
      {command_fmadm_faulty_pci_selected_lines_code}

      ILOM Open Problems:
      {ilom_open_problems_code}
    command_steps:
      - id: "fmadm_faulty_pci"
        cmd: "{faultmgmt} fmadm faulty -a"
        expect_status: 0
        expect_contains: "Suspect 1 of 1"
        line_contains: "Affects"
        line_before: 0
        line_after: 0
        stop_on_decision: false


- id: bifurcated_block_extract
  name: "Bifurcation detected â€“ extract PCIE info block"
  description: >
    If the ticket contains 'is_bifurcated: bifurcated', extract that line and
    the five lines before it from the failure message and include them in a
    Jira comment.
  priority: 15
  scope:
    arch: "EVE"
    jira_location:
      contains: "Fremont"
    jira_customer:
      contains: "EVE"
    db_latest_failed_testset:
      not_contains: "PRETEST"
  patterns:
    - type: contains
      value: "is_bifurcated: bifurcated"
  action:
    type: "comment_only"
    close: false
    failure_message_line_contains: "is_bifurcated: bifurcated"
    failure_message_line_before: 4
    failure_message_line_after: 0
    comment_template: |
      Test, please send to repair. 
      

      Repair,
      Please reseat PCI connections for the bifurcated component(s).

      Check if issue is solved by running command in hostnic:
      
      
        lspci -vvv -s [PCI_address]   | grep -i LnkSta


      {failure_message_selected_code}


- id: iou_bay_pcie_data_connector_missing_plain_english
  name: "IOU bay PCIe data connector missing in system (plain English)"
  description: >
    When hwdiag_io_config reports an IOU Bay in system as MISSING, extract the IOU bay and
    expected (GI) slot and state the issue in plain English.
  priority: 25
  scope:
    arch: "EVE"
    jira_location:
      contains: "Fremont"
    jira_customer:
      contains: "EVE"
    failure_message:
      contains: "MISSING"
    # Confirmation: require the same hwdiag block to be present in the ticket body too.
    combined_text:
      contains: "hwdiag_io_config -> IOU Bay"
  patterns:
    - type: contains
      value: "MISSING"
  action:
    type: comment_only

    text_extracts:
      - name: iou_bay
        source: failure_message
        line_contains: "hwdiag_io_config -> IOU Bay"
        line_between_start_contains: "IOU Bay "
        line_between_end_contains: " in GI"
        take: first
        default: "?"

      - name: gi_slot
        source: failure_message
        line_contains: "PCIe Data Connectors on IOU Module: ['"
        line_between_start_contains: "['"
        line_between_end_contains: "'"
        take: first
        default: "?"

    comment_template: |

      Test, please send to repair.

      Repair,

      IOU{iou_bay} PCIe connection is missing in the system. Expected PCIe cable in slot {gi_slot} (correct location).

      Please connect/seat the PCIe cable to slot {gi_slot} on IOU{iou_bay}.


- id: iou_bay_pcie_data_cable_not_connected_plain_english
  name: "IOU bay PCIe cable not connected in system (plain English)"
  description: >
    When hwdiag_io_cables shows a PCIe Data Cable expected in GI but "Not Connected" in system,
    call out the IOU bay and missing cable connection number(s) in plain English.
  priority: 30
  scope:
    arch: "EVE"
    jira_location:
      contains: "Fremont"
    jira_customer:
      contains: "EVE"
    # Confirmation: require the same hwdiag block to be present in the ticket body too.
    combined_text:
      contains: "hwdiag_io_config -> IOU Bay"
    failure_message:
      contains: "IOU Module: Not Connected"
  patterns:
    - type: contains
      value: "hwdiag_io_cables -> Cable#"
    - type: contains
      value: "IOU Bay: -, IOU Module: Not Connected"
  action:
    type: comment_only

    text_extracts:
      - name: iou_bay
        source: failure_message
        line_contains: "hwdiag_io_config -> IOU Bay"
        line_between_start_contains: "IOU Bay "
        line_between_end_contains: " in GI"
        take: first
        default: "?"

      - name: missing_connections
        source: failure_message
        line_contains: "IOU Bay: -, IOU Module: Not Connected"
        line_between_start_contains: "PCIe Data Cable#"
        line_between_end_contains: ": IOU Bay"
        take: all
        default: "?"

    comment_template: |

      Test, please send to repair.

      Repair,

      IOU{iou_bay} is missing PCIe cable connection(s): {missing_connections}

      Please reseat the PCIe cable(s) for the missing connection(s) on IOU{iou_bay}.


- id: iou_bay_pcie_data_connector_mismatch_plain_english
  name: "IOU bay PCIe data connector mismatch (plain English)"
  description: >
    When hwdiag_io_config shows IOU Bay connector mismatch between "in GI"
    (correct/expected) and "in system" (actual/wrong), extract the bay and
    connector numbers and state the mismatch in plain English.
  priority: 20
  scope:
    arch: "EVE"
    jira_location:
      contains: "Fremont"
    jira_customer:
      contains: "EVE"
    db_latest_failed_testset:
      not_contains: "PRETEST"
    # Confirmation: require the same hwdiag block to be present in the ticket body too.
    combined_text:
      contains: "hwdiag_io_config -> IOU Bay"
    failure_message:
      contains: "hwdiag_io_config -> IOU Bay"
  patterns:
    - type: contains
      value: "hwdiag_io_config -> IOU Bay"
    - type: not_contains
      value: "Not Connected"
  action:
    type: comment_only

    # Extract values using marker-based rules (no regex required).
    text_extracts:
      - name: iou_bay
        source: failure_message
        line_contains: "hwdiag_io_config -> IOU Bay"
        line_between_start_contains: "IOU Bay "
        line_between_end_contains: " in GI"
        take: first
        default: "?"

      - name: gi_slot
        source: failure_message
        # Pick the first connector list line (GI comes before system in hwdiag_io_config)
        line_contains: "PCIe Data Connectors on IOU Module: ['"
        line_between_start_contains: "['"
        line_between_end_contains: "'"
        take: first
        default: "?"

      - name: system_slot
        source: failure_message
        # Pick the last connector list line (system comes after GI in hwdiag_io_config)
        line_contains: "PCIe Data Connectors on IOU Module: ['"
        line_between_start_contains: "['"
        line_between_end_contains: "'"
        take: last
        default: "?"

    comment_template: |

      Test, please send to repair.
      
      Repair,


      IOU{iou_bay} has PCIe cable plugged into slot {system_slot} instead of slot {gi_slot} (correct location).


      Please verify this and move the PCIe cable to slot {gi_slot} for IOU{iou_bay}.


- id: ilom_pci_data_link_layer_inactive_affects
  name: "PCIe link layer inactive -> capture fmadm Affects line"
  description: >
    For EVE servers where ILOM reports a PCIe link-layer-inactive fault
    (fault.io.pcie.data-link-layer-inactive). Run faultmgmt "fmadm faulty -a"
    and surface the Affects line so repair can identify the impacted FRU/module.
  priority: 20
  allow_high_slt_attempts: true
  scope:
    arch: "EVE"
    jira_location:
      contains: "Fremont"
    jira_customer:
      contains: "EVE"
    db_latest_failed_testset:
      not_contains: "PRETEST"
    jira_comments_text:
      not_contains: "PCIe link-layer-inactive (fault.io.pcie.data-link-layer-inactive)"
  patterns:
    - type: contains
      value: "fault.io.pcie.data-link-layer-inactive"
  action:
    type: "comment_only"
    close: false
    ilom_filter_contains:
      - "fault.io.pcie.data-link-layer-inactive"
      - "PCIe link layer is inactive"
    comment_template: |

      Test, please send this server to repair.

      Repair,

      ILOM reports a PCIe link-layer-inactive fault:
      `fault.io.pcie.data-link-layer-inactive`

      Please reseat the affected module and its associated connections.

      fmadm faulty -a details (Affects line):
      {command_fmadm_faulty_pci_link_layer_inactive_selected_lines_code}

      ILOM Open Problems:
      {ilom_open_problems_code}
    command_steps:
      - id: "fmadm_faulty_pci_link_layer_inactive"
        cmd: "{faultmgmt} fmadm faulty -a"
        expect_status: 0
        expect_contains: "Suspect"
        line_contains: "Affects"
        line_before: 0
        line_after: 0
        stop_on_decision: false




# Untested rules
# Move rules out of this file once validated.
# Rule YAML reference (for rule authors): config/rules/RULES_YAML_REFERENCE.md

- id: pcie_lnksta_check_pretest_start_pretest_else_slt
  name: "PCIe link speed/width mismatch -> hostnic LnkSta (PRETEST)"
  description: >
    For PRETEST: run hostnic LnkSta for each PCIe address listed in the ticket (GI lines).
    If any output contains 'downgraded' OR any address has no output, send to repair and start SLT for logs.
    Otherwise start PRETEST and comment.
  priority: 30
  scope:
    arch: "EVE"
    jira_location:
      contains: "Fremont"
    jira_customer:
      contains: "EVE"
    db_latest_failed_testset:
      contains: "PRETEST"
  patterns:
    - type: contains
      value: "Link speed/width for PCIE slot"
    - type: contains
      value: "Check Result: FAIL"
    - type: contains
      value: "12_CHECK_PCIE_LINK_SPEED_WIDTH"
    - type: not_contains
      value: "The number of Drive on the UUT is inconsistent with the number on SFCS"
    - type: not_contains
      value: "The number of drives read on the server is inconsistent with that in ilom, seems some Drive is not ready."
  action:
    type: comment_only

    text_extracts:
      - name: pcie_addresses
        source: combined_text
        line_contains: ":00.0 in GI:"
        line_between_start_contains: "slot "
        line_between_end_contains: " in GI:"
        take: all
        default: ""

    command_steps:
      - id: pcie_lnksta
        for_each_extract: pcie_addresses
        cmd: "{hostnic} echo '--- [item] ---' ; lspci -vvv -s [item] | grep -i LnkSta"
        expect_status: 0
        expect_contains: "LnkSta"
        expect_not_contains: "downgraded"
        stop_on_decision: true

        start_testview_on_pass: true
        testview_operation_on_pass: "PRETEST"
        testview_use_validate_on_pass: true

        start_testview_on_fail: true
        testview_operation_on_fail: "SLT"
        testview_use_validate_on_fail: true

        on_expect_fail_comment: |
          Test, please send to repair.

          Repair,
          Host NIC PCIe link is downgraded OR LnkSta output is missing for one/more devices.

          Started SLT to generate logs for repair.

          Addresses checked (00.0 only):
          {pcie_addresses}

          Commands + output:
          {all_commands_code}

    comment_template: |
      PCIe LnkSta check looks OK on hostnic (no downgraded links and LnkSta output present for all addresses listed).

      Test,
      Started PRETEST.

      Addresses checked (00.0 only):
      {pcie_addresses}

      Commands + output:
      {all_commands_code}
      
- id: eve_pci_link_error_ssd_reseat
  name: "PCI link error on SSD -> capture fmadm Affects and send to repair"
  description: >
    For EVE servers where ILOM reports a PCI link error on an SSD FRU (e.g. /SYS/IOU8/SSD801).
    Run faultmgmt "fmadm faulty -a" and surface the Affects line so repair can identify which SSD/IOU is impacted.
    Ask repair to reseat the SSD module / backplane / IOU PCIe connections.

  priority: 24
  allow_high_slt_attempts: true

  scope:
    arch: "EVE"
    jira_location:
      contains: "Fremont"
    jira_customer:
      contains: "EVE"
    # usually not PRETEST-specific; keep it generic
    # if you want only NOT PRETEST, uncomment:
    # db_latest_failed_testset:
    #   not_contains: "PRETEST"

    # Make sure ILOM text exists (either in fetched ILOM or pasted into ticket)
    combined_text:
      contains: "A PCI link error has been detected on a PCI card."

  patterns:
    - type: contains
      value: "A PCI link error has been detected on a PCI card."
    # ensure it's SSD-related (match ILOM Open Problems line like "SSD801 (IOU 8 SSD 801)")
    - type: regex
      value: "(?i)\\bSSD\\s*\\d+\\b|/SYS/IOU\\d+/SSD\\d+"

  action:
    type: "comment_only"
    close: false

    ilom_filter_contains:
      - "A PCI link error has been detected on a PCI card."

    comment_template: |

      Test, please send this server to repair.

      Repair,

      ILOM reports a PCI link error on an SSD (reduced link speed).
      Please reseat the affected SSD module and its associated PCIe/backplane/IOU connections.
      If issue persists, swap SSD with a known-good one to verify if fault follows the SSD.

      fmadm faulty -a details (Affects line):
      {command_fmadm_faulty_ssd_pcie_selected_lines_code}

      ILOM Open Problems:
      {ilom_open_problems_code}

    command_steps:
      - id: "fmadm_faulty_ssd_pcie"
        cmd: "{faultmgmt} fmadm faulty -a"
        expect_status: 0
        expect_contains: "Suspect"
        # limit to the SSD affects line
        line_contains: "Affects"
        line_before: 0
        line_after: 0
        # optional: only keep lines that mention SSD/IOU in that affects line
        # (if your command_steps supports an additional filter; if not, ignore)
        stop_on_decision: false



#==========================================================================================================================================================
- id: eve_hwdiag_on_vr_check_all_nonzero_route_fallback
  name: "EVE HWDIAG_ON: vr_check all non-zero (fallback matcher)"
  priority: 80
  allow_on_same_failure: true
  scope:
    arch: "EVE"
    jira_location:
      contains: "Fremont"
    jira_customer:
      contains: "EVE"
    failure_message:
      contains: "hwdiag cpld vr_check all"
  patterns:
    - type: contains
      value: "2_HWDIAG_ON"
    - type: contains
      value: "hwdiag cpld vr_check all"
  action:
    type: "comment_only"
    close: false
  
    comment_template: |
  
      Test, please send to repair
      
      Repair,
      HWDIAG_ON failed on `hwdiag cpld vr_check all` (non-zero).
      Key output:
      {command_vr_check_selected_lines_code}
  
    command_steps:
      - id: "vr_check"
        cmd: "{diag} hwdiag cpld vr_check all"
        expect_status: 0
        stop_on_decision: false
  
        # ???????????(??????? sshpass/ILOM banner)
        line_contains: "Voltage Regulator Check Result"
        line_before: 120
        line_after: 20
        line_only: false


